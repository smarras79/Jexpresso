function user_flux!(F, G, SD::NSD_{{ spatial_dim }}D,
                    q,
                    qe,
                    mesh::St_mesh,
                    ::CL, ::TOTAL; neqs={{ num_equations }}, ip=1)

    PhysConst = PhysicalConst{Float64}()

    # Extract conservative variables
    {%- for i, var in enumerate(variables) %}
    {{ var }} = q[{{ i+1 }}]
    {%- endfor %}

    {%- if has_pressure %}
    # Calculate pressure (TODO: Adjust based on equation of state)
    Press = 0.0  # TODO: Define pressure calculation
    {%- endif %}

    # X-direction fluxes
    {%- for i, flux in enumerate(flux_x) %}
    F[{{ i+1 }}] = {{ flux }}
    {%- endfor %}

    {%- if spatial_dim >= 2 %}
    # Y-direction fluxes
    {%- for i, flux in enumerate(flux_y) %}
    G[{{ i+1 }}] = {{ flux }}
    {%- endfor %}
    {%- endif %}
end

function user_flux!(F, G, SD::NSD_{{ spatial_dim }}D,
                    q,
                    qe,
                    mesh::St_mesh,
                    ::CL, ::PERT; neqs={{ num_equations }}, ip=1)

    PhysConst = PhysicalConst{Float64}()

    # Extract conservative variables (perturbation form)
    {%- for i, var in enumerate(variables) %}
    {{ var }} = q[{{ i+1 }}] + qe[{{ i+1 }}]
    {%- endfor %}

    {%- if has_pressure %}
    # Calculate pressure
    Press = 0.0  # TODO: Define pressure calculation
    Press = Press - qe[end]
    {%- endif %}

    # X-direction fluxes
    {%- for i, flux in enumerate(flux_x) %}
    F[{{ i+1 }}] = {{ flux }}
    {%- endfor %}

    {%- if spatial_dim >= 2 %}
    # Y-direction fluxes
    {%- for i, flux in enumerate(flux_y) %}
    G[{{ i+1 }}] = {{ flux }}
    {%- endfor %}
    {%- endif %}
end

function user_flux!(F, G, SD::NSD_{{ spatial_dim }}D,
                    q,
                    qe,
                    mesh::St_mesh,
                    ::NCL, ::AbstractPert; neqs={{ num_equations }}, ip=1)

    PhysConst = PhysicalConst{Float64}()

    # Extract variables (non-conservative form)
    {%- for i, var in enumerate(variables) %}
    {{ var }} = q[{{ i+1 }}]
    {%- endfor %}

    {%- if has_pressure %}
    # Calculate pressure
    Press = 0.0  # TODO: Define pressure calculation
    {%- endif %}

    # X-direction fluxes (non-conservative form)
    {%- for i, flux in enumerate(flux_x) %}
    F[{{ i+1 }}] = {{ flux }}
    {%- endfor %}

    {%- if spatial_dim >= 2 %}
    # Y-direction fluxes (non-conservative form)
    {%- for i, flux in enumerate(flux_y) %}
    G[{{ i+1 }}] = {{ flux }}
    {%- endfor %}
    {%- endif %}
end

function user_flux_gpu(q, qe, PhysConst, lpert)
    T = eltype(q)

    if (lpert)
        # Perturbation form
        {%- for i, var in enumerate(variables) %}
        {{ var }} = q[{{ i+1 }}] + qe[{{ i+1 }}]
        {%- endfor %}

        {%- if has_pressure %}
        Pressure = T(0.0)  # TODO: Define pressure calculation
        {%- endif %}

        return {%- for i, flux in enumerate(flux_x) %}T({{ flux }}){%- if not loop.last %}, {% endif %}{%- endfor %}{%- if spatial_dim >= 2 %}, {%- for i, flux in enumerate(flux_y) %}T({{ flux }}){%- if not loop.last %}, {% endif %}{%- endfor %}{%- endif %}
    else
        # Total form
        {%- for i, var in enumerate(variables) %}
        {{ var }} = q[{{ i+1 }}]
        {%- endfor %}

        {%- if has_pressure %}
        Pressure = T(0.0)  # TODO: Define pressure calculation
        {%- endif %}

        return {%- for i, flux in enumerate(flux_x) %}T({{ flux }}){%- if not loop.last %}, {% endif %}{%- endfor %}{%- if spatial_dim >= 2 %}, {%- for i, flux in enumerate(flux_y) %}T({{ flux }}){%- if not loop.last %}, {% endif %}{%- endfor %}{%- endif %}
    end
end
